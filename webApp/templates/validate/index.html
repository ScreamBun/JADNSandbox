{% extends "static/base.html" %}
{% block body %}
    {% include "static/nav.html" %}

    <div id="alert-container" class="w-50"></div>

    <div class="container-fluid mt-3">
        <div class="row">
            <form id="validate-form" class="mx-auto col-12 position-relative" action="/validate" method="post" onsubmit="return submitForm();">
				<div class="form-group position-absolute" style="right: 1.25em;">
                    <button type="submit" class="btn btn-outline-primary">Validate</button>
                    <button type="reset" class="btn btn-outline-danger">Reset</button>
                </div>
				
                <fieldset>
                    <legend>JADN Schema</legend>
					<div class="form-row">
						<div class="col-md-12 mb-3">
							<div id="schema-card" class="tab-pane fade active show">
								<div class="card">
									<div class="card-header">										
										<div class="row float-left col-sm-6 pl-0">
											<div class="form-group col-md-6 pr-0 pl-1">
												<select id="schema-list" name="schema-list" class="form-control">
													<option value="empty" selected="">Schema</option>
													{% for opt in options.schemas %}
														<option value="{{ opt }}">{{ opt }}</option>
													{% endfor %}
													<option disabled="">──────────</option>
													<option value="file">File...</option>
													<option value="url">URL...</option>
												</select>
											</div>

											<div id="schema-file-group" class="form-group col-md-6 d-none px-1">
												<input type="file" class="btn btn-light form-control-file" id="schema-file" name="schema-file" accept=".jadn">
											</div>

											<div id="schema-url-group" class="form-group col-md-6 d-none px-1">
												<div class="input-group">
													<div class="input-group-prepend">
														<button type="button" class="btn btn-info" onclick="loadURL('schema')">Load URL</button>
													</div>
													<input type="text" class="form-control" id="schema-url">
												</div>
											</div>
										</div>
										
										<div class="float-right btn-group">
											<button type="button" class="btn btn-outline-secondary" onclick="format('schema')">Format</button>
											<button type="button" class="btn btn-outline-secondary" onclick="format('schema')">Verbose</button>
											<button type="button" class="btn btn-outline-secondary" onclick="minify('schema')">Minify</button>
											<button type="button" class="btn btn-outline-secondary" onclick="verifySchema()">Verify</button>
										</div>
									</div>
									
									<textarea class="form-control border card-body p-2" placeholder="Paste JADN schema here" id="schema" name="schema" rows="10" required=""></textarea>
								</div>
							</div>
						</div>
					</div>
                </fieldset>

                <fieldset>
                    <legend>Message</legend>					
					<div class="form-row">
						<div class="col-md-12 mb-3">
							<ul class="nav nav-tabs submitted">
								<li class="nav-item">
									<a class="nav-link active show" data-toggle="tab" href="#message-card">Original</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" data-toggle="tab" href="#json-card">JSON</a>
								</li>
							</ul>
							<div class="tab-content">
								<div id="message-card" class="tab-pane fade active show">
									<div class="card">
										<div class="card-header">											
											<div class="row float-left col-sm-6 pl-0">
												<div class="form-group col-md-6 pr-0 pl-1">
													<select id="message-list" name="message-list" class="form-control">
														<option value="empty" selected="">Message</option>
														{% for opt in options.messages %}
															<option value="{{ opt.name }}" decode="{{ opt.type }}">{{ opt.name }}</option>
														{% endfor %}
														<option disabled="">──────────</option>
														<option value="file">File...</option>
														<option value="url">URL...</option>
													</select>
												</div>

												<div id="message-file-group" class="form-group col-md-6 d-none px-1">
													<input type="file" class="btn btn-light form-control-file" id="message-file" name="message-file" accept=".json,.xml,.cbor">
												</div>

												<div id="message-url-group" class="form-group col-md-6 d-none px-1">
													<div class="input-group">
														<div class="input-group-prepend">
															<button type="button" class="btn btn-info" onclick="loadURL('message')">Load URL</button>
														</div>
														<input type="text" class="form-control" id="message-url">
													</div>
												</div>
											</div>
											
											<div class="float-right btn-group">
												<button type="button" class="btn btn-outline-secondary" onclick="format('message')">Format</button>
												<button type="button" class="btn btn-outline-secondary" onclick="format('message')">Verbose</button>
												<button type="button" class="btn btn-outline-secondary" onclick="minify('message')">Minify</button>
											</div>
										</div>
										
										<textarea class="form-control border card-body p-2" placeholder="Paste message to be validated here" id="message" name="message" rows="10" required=""></textarea>
									</div>
								</div>
							
								
								<div id="json-card" class="tab-pane fade">
									<div class="card">
										<div class="card-header">
											<div class="float-right btn-group">
												<button type="button" class="btn btn-outline-secondary" onclick="format('message-json', indent, 'json')">Verbose</button>
												<button type="button" class="btn btn-outline-secondary" onclick="minify('message-json', 'json')">Minify</button>
											</div>
										</div>
										
										<textarea class="form-control border card-body" id="message-json" rows="10" readonly="readonly"></textarea>
									</div>
								</div>
							</div>
						</div>
					</div>
						
					<div class="form-row-fluid">
						<div class="float-left form-group col-md-3 col-sm-6 pr-1 pl-1">
							<label class="control-label" for="message-format">Message Format</label>
							<select class="form-control" id="message-format" name="message-format" required="">
								<option value="" selected="">Message Format</option>
								<option value="json">json</option>
								<option value="cbor">cbor</option>
								<!--<option value="protobuf">protobuf</option>-->
								<option value="xml">xml</option>
							</select>
						</div>
						
						<div class="float-left form-group col-md-3 col-sm-6 pr-1 pl-1">
							<label class="control-label" for="message-decode">Message Type</label>
							<select class="form-control" id="message-decode" name="message-decode" required="">
								<option value="" selected="">Message Type</option>
							</select>
						</div>
					</div>
                </fieldset>
            </form>
        </div>
    </div>
{% endblock %}

{% block page_script %}
<script type="text/javascript" src="{{ url_for('static', filename='js/vkbeautify.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script type="text/javascript">
	$('.submitted').hide()
	var decodeTypes = [],
		jadnTypes = ['Record', 'Enumerated', 'Choice', 'Map', 'Array', 'ArrayOf']
	
    $("#schema-list, #message-list").change(function(e) {
        id = $(e.target).attr("id")
		type = id.split('-')[0]
        selected = $(e.target).val()
		decodeType = $(e.target).find('option:selected').attr('decode')
		
		$("#"+type+"-file-group").addClass("d-none")
		
        if (selected == "" || selected == null) {
			$("#"+type+"-url-group").removeClass("d-none")
			$("#"+type+"-file-group").removeClass("d-none")
            return
        } else if (selected == "empty") {
			$("#"+type).text("").val("")
			$("#"+type+"-file-group").addClass("d-none")
			$("#"+type+"-url-group").addClass("d-none")
			if (type == 'message') {
				$("#message-format").val('')
				$('#message-decode').val('')
			}
            return
        } else if (selected == "file") {
			$("#"+type+"-url-group").addClass("d-none")
			$("#"+type+"-file-group").removeClass("d-none")
			return
		} else if (selected == "url") {
			$("#"+type+"-file-group").addClass("d-none")
			$("#"+type+"-url-group").removeClass("d-none")
			return
		} else {
			$("#"+type+"-file-group").addClass("d-none")
			$("#"+type+"-url-group").addClass("d-none")
		}

        $.get(
            "/load/"+type+"s/"+selected,
            function(data) {
				if (data['type'] == type+"s" && data['file'] == selected) {
					$("#"+type).removeClass('minify format')
					
					if (type == "message") {
						t = data['file'].split('.')[1]
						$("#message-format").val(t)
						switch(t) {
							case 'cbor':
								$("#"+type).addClass('minify')
								d = cbor2bytes(data['data'])
								break
							default:
								d = data['data']
						}
						$("#"+type).text(d).val(d)
						if (decodeType != undefined) {
							$('#message-decode').val(decodeType)
						}
						
					} else if (type == "schema") {
						$("#"+type).text(data['data']).val(data['data'])
						loadDecodeTypes()
					}
				} else {
					alertMsg("#alert-container", "Cannot load data")
				}
            }
        ).fail(function() {
			alertMsg("#alert-container", "Cannot load data")
        })
    })
	
	$("#schema-file, #message-file").change(function(e) {
		// TODO: NEEDS WORK!!!
		id = $(e.target).attr("id").split('-')[0]
		var fileReader = new FileReader()
		
    	fileReader.onload = function (e) {
			data = fileReader.result
			try {
				dataStr = atob(data.split(',')[1])
				j = JSON.stringify($.parseJSON(dataStr), null, indent)
            } catch(e) {
				data = atob(data.substr(data.indexOf(',')+1))
				$("#"+type).addClass('minify')
				j = cbor2bytes(data.hexify())
            }
			$("#"+id).text(j).val(j)
			
			if (id == "schema") {
				loadDecodeTypes()
			}
    	}
		
    	fileReader.readAsDataURL($(e.target).prop('files')[0])
		t = $(e.target).prop('files')[0].name.split('.')[1]
		$("#message-format").val(t)
	})

    $("button[type='reset']").click(function(e) {
        $("textarea").each(function(i, e) {
            $(e).text("").val("").removeClass('minify format')
        });
    })
	
	$("#schema").on('input change paste', loadDecodeTypes)
	
	function loadURL(id) {
		url = $('#'+id+'-url').text() || $('#'+id+'-url').val()
		if ($.inArray(url, [null, '', ' ']) >= 0) {
			alertMsg("#alert-container", "Invalid url, please check what you typed")
			return
		}
		
		file = url.substring(url.lastIndexOf("/") + 1)
		fileName = file.substring(0, file.lastIndexOf("."))
		fileExt = file.substring(file.lastIndexOf(".") + 1)
		
		formatMsg = false
		hexifyMsg = false
		
		switch (fileExt) {
			case 'jadn':
				formatMsg = true
				if (id != 'schema'){
					alertMsg("#alert-container", "Cannot load {ext} data as {id}".format({id: id, ext: fileExt}))
					return
				}
				break;
			case 'cbor':
				hexifyMsg = true
			case 'json':
				formatMsg = true
			case 'xml':
				if (id != 'message'){
					alertMsg("#alert-container", "Cannot load {ext} data as {id}".format({id: id, ext: fileExt}))
					return
				}
				$("#message-format").val(fileExt)
				break;
			default:
				alertMsg("#alert-container", "Cannot load {id} data, improper file type {ext}".format({id: id, ext: fileExt}))
				return
		}

		$.get(
			url,
			function(data) {
				if (hexifyMsg) {
					data = cbor2bytes(data.hexify())
					$('#'+id).text(data).val(data)					
				} else if (formatMsg) {
					$('#'+id).text(data).val(data)
					format(id)
				}
			}
		).fail(function() {
			alertMsg("#alert-container", "An error has occured loading the {id} data from {file}.Check the URL and try again".format({id: id, file: file}))
		})
	}
	
	function loadDecodeTypes() {
		data = $("#schema").val() || $("#schema").text()
		try {
			schema = $.parseJSON(data)
		} catch (e) {
			schema = {}
		}
		
		if (schema.hasOwnProperty('types')) {
			schemaTypes = $.map($.parseJSON(data)['types'], function(v) {
				if ($.inArray(v[1], jadnTypes) >= 0) {
					return v[0]
				}
			})
		} else {
			schemaTypes = []
		}
		
		if (schema.hasOwnProperty('meta')) {
			if (schema['meta'].hasOwnProperty('exports')) {
				$.each(schema['meta']['exports'], function(k, v) {
					if ($.inArray(v, schemaTypes) == -1) {
						schemaTypes.push(v)
					}
				})
			}
		}
		
		schemaTypes.sort()
		if (!isEquivalent(schemaTypes, decodeTypes)) {
			decodeTypes = schemaTypes.slice()

			$("#message-decode option.schema_record").remove()
			$.each(decodeTypes, function(i, v) {
				opt = $("<option/>").addClass("schema_record").attr("value", v).text(v)
				$("#message-decode").append(opt)
			})
		}
	}

    function submitForm() {
		$('*').removeClass('border-danger')
		schema = $("#schema").val() || $("#schema").text()
        try {
            $.parseJSON(schema)
        } catch(e) {
			alertMsg("#alert-container", "Schema Invalid")
			$('#schema-card .card').addClass('border-danger')
			return false
        }
		
		message = $("#message").val() || $("#message").text()
		message_type = $("#message-format").val()
		
		if ($.inArray(message_type, [null, undefined, "", "empty"]) >= 0) {
			alertMsg("#alert-container", "Message format not selected")
			return false
		} else {
			switch (message_type) {
				case 'cbor':
					minify('message')
					sleep(500)
					break;
				case 'json':
					try {
						$.parseJSON(message)
					} catch(e) {
						alertMsg("#alert-container", "Message Invalid")
						$('#massage-card .card').addClass('border-danger')
						return					
					}
					break
				default:
					break
			}
		}		
		
		decode = $("#message-decode option:selected").val()
		if ($.inArray(decode, [null, undefined, "", "empty"]) >= 0) {
			alertMsg("#alert-container", "Message Decode Type not selected")
			return false
		}
		
		form = $("#validate-form")
		$.ajax({
			type: form.attr('method'),
			url: form.attr('action'),
			data: form.serialize()
		}).done(function(data) { // Submit success
			if (data.valid_bool) {
				$('.nav-tabs a[href="#message-card"]').tab('show')
				$('.submitted')[data.message_format=='json'?'hide':'show']()
				
				alertMsg("#alert-container", data.valid_msg, 4)
				$("#message-json").text(data.message_json)
				format('message-json', indent, 'json')
				
			} else {
				alertMsg("#alert-container", data.valid_msg, 5, 0)
				if (data.valid_msg.match(/^Schema/)) {
					$('#schema-card .card').addClass('border-danger')
				} else if (data.valid_msg.match(/^Message/)) {
					$('#message-card .card').addClass('border-danger')
				} else if (data.valid_msg.match(/^Decode/)) {
					$('#message-decode').addClass('border-danger')
				} else {
					console.log('umm....')
				}
			}			
		}).fail(function(data) {// Submit fail
			alertMsg("#alert-container", 'Form submit failed, please try again')
		})
		
        return false
    
	}
	
	function verifySchema(id) {
		data = $("#schema").val() || $("#schema").text()
		
		 $.post(
            "/validate/schema",
			{
				"schema": data
			},
            function(d) {
				if (d['valid_bool']) {
					msg = "Valid Schema: " + d['valid_msg']
					alertMsg("#alert-container", msg, 3)
				} else {
					msg = "Invalid Schema: " + d['valid_msg'].replace(/^.*?\-/, '')
					alertMsg("#alert-container", msg)
				}
			}
		)
	}
</script>
{% endblock %}